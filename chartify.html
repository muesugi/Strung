<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Strung</title>
		<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
		<script src="js/canvg.js"></script> 
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
			#container {width: 100%; height: 500px;}
		</style>
	</head>
	<body>

	<canvas id="canvas" style="display:none;"></canvas>
	<div id="container"> </div>
	<textarea id="textarea" spellcheck=false></textarea>

	<script>
		//globals:
		var paper = Raphael(document.getElementById('container'), "100%", "100%"); 
		//creates the canvas. 100% of 50% of window size

		var xpos_0 = 100;
		var ypos_0 = 300;

		var xpos = xpos_0;
		var ypos = ypos_0;

		var row_max_height = 0;
		var past_row_widths = [];
		var cur_row_widths = [];

		//magnitude? 
		var direction = 1;

		var stitch_widths = { //all real stitch width
			"chain": 30,
			"slip": 10, 
			"single": 12, 
			"half_double": 10, 
			"double": 10, 
			"treble": 10, 
			"double_treble": 10};
		var stitch_heights = { //all real stitch width
			"chain": 10,
			"slip": 10, 
			"single": 12, 
			"half_double": 20, 
			"double": 20, 
			"treble": 20, 
			"double_treble": 20};

		//SYMBOLS -- abstracting out relative position
		//named according to US crochet convention
		//see http://dabblesandbabbles.com/wp-content/uploads/2014/02/Crochet-Symbols-Chart1.pdf
		//xpos and ypos should be the bottommost, leftmost point
		function red_dot(){//TESTING ONLY:: for viewing xpos, ypos
			red = paper.circle(xpos, ypos, 2);
			red.attr({fill: "red"});
		}
		function chain(start_x, start_y){ //simple rendering of chain (ch) symbol
			ch_center_x = start_x + direction*15; //center x of ellipse
			ch_center_y = start_y - 5; // minus bc it grows up
			ch = paper.ellipse(ch_center_x, ch_center_y, 15, 5);
			//horizontal radius == 15, vertical radius == 5
		}
		function slip(start_x, start_y){ // slip stitch (sl st)
			slst_center_x = start_x + direction*5;
			slst_center_y = start_y - 5;
			slst = paper.circle(slst_center_x, slst_center_y, 5);
			slst.attr({"fill": "#000"});
		}
		function single(start_x, start_y){ // single crochet (sc)
			sc_vert = paper.path("M"+(start_x+direction*6)+","+start_y+"v"+(-12)); //bottom-up
			//line from (xpos+6, ypos) to (xpos+6, ypos-12)
			sc_hor = paper.path("M"+(start_x)+","+(start_y-6)+"h"+(direction*12));
			//line from (xpos, ypos-6) to (xpos+12, ypos-6)
			//make both lines bolder?	
		}
		function half_double(start_x, start_y){ // half double crochet (hdc)
			hdc_center_x = start_x + direction*5;
			hdc_vert = paper.path("M"+hdc_center_x+","+start_y+"v"+(-20));
			//line from (xpos+5, ypos) to (xpos+5, ypos-20)
			hdc_hor = paper.path("M"+(start_x)+","+(start_y-20)+"h"+(direction*10));
			//line from (xpos, ypos-20) to (xpos+10, ypos-20)
		}
		function double(start_x, start_y){ // double crochet (dc)
			dc_center_x = start_x + direction*5;
			dc_vert = paper.path("M"+dc_center_x+","+start_y+"v"+(-20));
			//line from (xpos+5, ypos) to (xpos+5, ypos-20)
			dc_hor = paper.path("M"+(start_x)+","+(start_y-20)+"h"+(direction*10));
			//line from (xpos, ypos-20) to (xpos+10, ypos-20)
			dc_dia = paper.path("M"+(dc_center_x-4)+","+(start_y-13)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-13) to (xpos+9, ypos-13+sqrt(17))
			//length is sqrt(64 + 17) == sqrt(81) == 9
		}
		function treble(start_x, start_y){ // treble crochet (tc)
			tr_center_x = start_x + direction*5;
			tr_vert = paper.path("M"+tr_center_x+","+start_y+"v"+(-20));
			//line from (xpos, ypos) to (xpos, ypos-20)
			tr_hor = paper.path("M"+(start_x)+","+(start_y-20)+"h"+(direction*10));
			//line from (xpos, ypos-20) to (xpos+10, ypos-20)
			tr_dia1 = paper.path("M"+(tr_center_x-4)+","+(start_y-15)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-15) to (xpos+9, ypos-15+sqrt(17))
			//length is sqrt(64 + 17) == sqrt(81) == 9
			tr_dia2 = paper.path("M"+(tr_center_x-4)+","+(start_y-12)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-12) to (xpos+9, ypos-12+sqrt(17))
		}
		function double_treble(start_x, start_y){ // treble crochet (tc)
			dtr_center_x = start_x + direction*5;
			dtr_vert = paper.path("M"+dtr_center_x+","+start_y+"v"+(-20));
			//line from (xpos+5, ypos) to (xpos+5, ypos-20)
			dtr_hor = paper.path("M"+(start_x)+","+(start_y-20)+"h"+(direction*10));
			//line from (xpos, ypos-20) to (xpos+10, ypos-20)
			dtr_dia1 = paper.path("M"+(dtr_center_x-4)+","+(start_y-16)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-16) to (xpos+8, ypos-16+sqrt(17))
			//length is sqrt(64 + 17) == sqrt(81) == 9
			dtr_dia2 = paper.path("M"+(dtr_center_x-4)+","+(start_y-13)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-13) to (xpos+9, ypos-13+sqrt(17))
			dtr_dia3 = paper.path("M"+(dtr_center_x-4)+","+(start_y-10)+"l"+8+","+(Math.sqrt(17)));
			//line from (xpos+1, ypos-10) to (xpos+9, ypos-10+sqrt(17))
		}
		function turn(){
			ypos = ypos - row_max_height - 2; //growing up //-2 for separation
			row_max_height = 0; 
			direction = -1 * direction;
			past_row_widths = cur_row_widths;
			cur_row_widths = [];
		}
		/// RENDER symbols

		function call_stitch(funcname, n_stitches){
			//paper.setViewBox(0,0,650,650,false);
			//console.log(stitch_widths);
			st_type_width = stitch_widths[funcname];
			row_max_height = Math.max(row_max_height, stitch_heights[funcname]);

			for(i = 0; i < n_stitches; i++){
				below_st_width = past_row_widths.shift()

				if (below_st_width > 0){
					cur_st_width = Math.max(below_st_width, st_type_width); 
					start_xpos = xpos + (direction*(below_st_width/2)) + (-1 * direction * (st_type_width/2));
				}
				else{
					cur_st_width = st_type_width;
					start_xpos = xpos;
				}
				window[funcname](start_xpos, ypos); //calls correct symbol based on funcname
				//red_dot();
				
				xpos = xpos + direction * cur_st_width;
				cur_row_widths.unshift(cur_st_width); //add to front of array
			}
			

			//adds the canvas contents to the hidden image.
			canvg('canvas', $("#container").html());
			/*// the canvas calls to output a png
			var canvas = document.getElementById("canvas");
			var img = canvas.toDataURL("image/png");
			$('#converted_image').attr('src', img);*/
		}

		$("#textarea").keypress(function(event){
			//alert(event.which);
		    if (event.which == 59){ // on semicolon, parse input
		    	parse_input($("#textarea").val()); //style choice to pass the string. 
		    }
		    	//alert(String.fromCharCode(event.which)); 
		 })

		function parse_input(pattern_string){
			xpos = xpos_0;
			ypos = ypos_0;
			direction = 1;
			row_max_height = 0;
			past_row_widths = [];
			cur_row_widths = [];
			paper.clear();//redraw every time

			clean_pattern = pattern_string.replace(/\s+/g, '');
			func_call_strings = clean_pattern.split(";");

			for (f = 0; f < func_call_strings.length; f++){
				split_func_call = func_call_strings[f].split("(");
				func_name = (split_func_call[0]).toLowerCase();
				if (func_name == "turn"){
					turn();
				}
				else if (func_name == "color"){}
				else if (func_name == "repeat"){}
				else{
					n_stitches = Number(split_func_call[1].slice(0, -1));		
					//cut off last ")" char
					call_stitch(func_name, n_stitches);
				}	
			}

		}
		</script>
	</body>
</html>